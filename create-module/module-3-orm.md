# Создание модуля (ORM)
https://hmarketing.ru/blog/bitrix/struktura-modulya/  
Создание модуля с использованием ORM и созданием таблиц в БД, при установке модуля.  
Создаём партнёрский модуль `damir.bd`:
- точкой входа в модуль и главным файлом установки является `/local/modules/damir.bd/install/index.php`, где располагается класс `class damir_bd extends CModule { }`
- главным файлом модуля является `/local/modules/damir.bd/lib/Main.php`

## Структура проекта
Папка `damir.bd/` содержит:
- admin/
  - menu.php меню в админке Битрикс
- install/
  - copy_files/
    - test.php - файл который будет скопирован в damir.bd/
  - db/
    - `install.sql` - запросы, которые выполняются при установке модуля
    - `uninstall.sql` - запросы, которые выполняются при удалении модуля
  - index.php - основной файл установки
  - version.php - файл с версией и датой выхода модуля
  - instalInfo.php - вывод сообщения в админке сайта об ошибке или успехе при установке модуля
  - deInstalInfo.php вывод сообщения в админке сайта об ошибке или успехе при удалении модуля
- lang/
  - ru/
    - lib/
      - data.php - языковой файл базы данных
    - install/
      - instalInfo.php - языковой файл вывода сообщения в админке сайта об ошибке при установке модуля
      - deInstalInfo.php - языковой файл вывода сообщения в админке сайта об ошибке при удалении модуля
      - index.php - языковой файл основного файла установки
- lib/
  - Main.php - основной класс модуля
  - data.php - настройки ORM
- include.php - используется для подключения файлов модуля
- options.php - настройки модуля в админке

## admin/
## admin/menu.php
Файл вызывается ядром Битрикс автоматически при установке модуля.  
Данный файл создаёт пункты меню в административном интерфейсе Битрикс.

В файле небходимо создать массив `$aMenu`, в котором указываются параметры меню, полный состав массива можно посмотреть на официальном сайте: https://dev.1c-bitrix.ru/api_help/main/general/admin.section/menu.php:

## install/
### install/copy_files/test.php
Файл копируется в папку `damir.bd/test.php` при установке модуля. Копирование вызывается из `install/index.php`

При инициализации файла, происходит вызов зарегистрированного в системе события, которое выводит запись из базы на экран. Более подробная информация про события Битрикс: https://dev.1c-bitrix.ru/api_help/main/events/index.php

### install/db/install.sql
Файл вызывается при установке модуля из /install/index.php  
В файле указан простой запрос на создание таблицы `damir_test` и заполнением таблицы данными.

### install/db/uninstall.sql
Файл вызывается из `/install/index.php` при удалении модуля.  
В файле указан простой запрос на удаление таблицы `damir_test`:

    DROP TABLE IF EXISTS `damir_test`;

### install/index.php
Файл вызывается ядром Битрикс автоматически при установке модуля.

Инсталлятор должен находиться в директории `/install/index.php`. Имя класса должно соответствовать названию папки модуля и являться наследником от CModule. Только вместо точки, если мы делаем партнерский модуль стоит прописать нижнее подчеркивание, это нужно для определения модуля в системе. Файл выполняется при установке или удалении модуля через административный интерфейс.

В конструкторе класса указывается справочная информация о модуле, часть информации обязательна, часть нет. Данный класс должен присвоить значения свойствам:

    public $MODULE_NAME;
    public $MODULE_DESCRIPTION;
    public $MODULE_VERSION;
    public $MODULE_VERSION_DATE;
    public $MODULE_ID;
    public $MODULE_SORT;
    public $SHOW_SUPER_ADMIN_GROUP_RIGHTS;
    public $MODULE_GROUP_RIGHTS;
    public $PARTNER_NAME;
    public $PARTNER_URI;

Тут все довольно тривиально, за исключением версии модуля. Номер версии модуля должен храниться в файле `/install/version.php` в виде массива. Плюс к этому нужно в классе модуля записывать эти значения.

Среди методов класса инсталлятора, должны обязательно присутствовать:
- **DoInstall** - отрабатывает при установке модуля, внутри должна вызываться функция `RegisterModule` для регистрации модуля в базе. Так же доступны дополнительные методы для: создания/удаления таблицы в базе, установки/удаления событий и дополнительных файлов модуля. Для реализации нашего модуля не нужны события и дополнительные файлы, методы оставим пустыми для будущего расширения возможностей модуля.
- **DoUninstall** - отрабатывает при удалении модуля, внутри должна вызываться функция `UnRegisterModule` для удаления регистрации модуля в базе. Так же доступны дополнительные методы для: создания/удаления таблицы в базе, установки/удаления событий и дополнительных файлов модуля. Для реализации нашего модуля не нужны события и дополнительные файлы, методы оставим пустыми для будущего расширения возможностей модуля.

Кроме этого, заложены заранее предустановленные наборы методов, которые должны проинсталлировать файлы модуля, события и данные для БД - `InstallFiles`, `InstallEvents`, `InstallDB` в автоматическом режиме.

### install/version.php
Файл вызывается при установке модуля из `/install/index.php`.

Номер версии модуля должен храниться в файле `/install/version.php` в виде массива. Плюс к этому нужно в классе модуля записывать эти значения. В связи с этим нужно написать небольшой код, который будет брать значения из этого файла и записывать его в модуль:

### install/installInfo.php
Файл вызывается при установке модуля из `/install/index.php`  
Файл выводит сообщение в админке сайта об ошибке или успехе при установке модуля:

### /install/deInstallInfo.php
Файл вызывается при удалении модуля из `/install/index.php`  
Файл выводит сообщение в админке сайта об ошибке или успехе при удалении модуля:

## lang/
Файлы вызываются ядром Битрикс автоматически при установке модуля.  
Файлы служат для реализации переводов, в них находится простой массив `$MESS` в котором хранятся пары ключ=>значение перевода, часть `ru/` в пути к файлу является указанимем на язык перевода.

### lang/ru/lib/data.php
### lang/ru/install/deInstallInfo.php

## lib/
### lib/Main.php
Файл вызывается из файла /include.php  
В данном файле пристуствует `namespace`, который называется в соответвии с требованиями Битрикс. В нем будет храниться основная логика работы модуля, для примера реализуем в данном файле получение одной записи из таблицы модуля с помощью `ORM` класса `DataTable`.

### lib/data.php
Данный файл служит для организации доступа к таблице с помощью `ORM`, в нём создаётся класс `DataTable`, который наследуется от класса `Entity\DataManager`, который в свою очередь реализует парадигму `ORM`. Для того что бы подключить наш класс к `ORM`, мы должны указать имя таблицы и задать структуру, для этого есть 2 метода `getTableName` и `getMap` соответственно. У Битрикс есть автогенерация класса для реализации ORM:

## include.php
Файл необходим для подключения классов или дополнительных файлов модуля. Если соблюдать соответствие namespace и имени модуля, то поддерживается автозагрузка класса. Автозагрузка работает медленнее, чем поключение файла в `include.php`

Если необходимо протестировать автозагрузку классов, нужно закомментировать строку, которая подключает наш класс и запустить тестовую страницу снова.

## options.php
Полезно выносить настройки решения на отдельную страницу админки, для возможности администратора сайта влиять на работу модуля. В Битрикс можно создавать страницы с параметрами для своих модулей.

Для всех элементов формы настройки модуля, автоматически создаются свои поля в таблице `b_option`, при сохранении формы, значения соответствующих строк в базе будут обнавлены.

В панели Битрикс сама страница с настройками находится по адресу `Настройки > Настройки модулей > Имя_модуля`:

## Итого:
Для тестирования модуля, вы должны выполнить следующие шаги:
- Установить модуль в административном интерфейсе
- Перейти на страницу `Ваш_сайт.com/damir.db/test.php`
- Если модуль корректно установился, на экране монитора должен появиться вывод массива
